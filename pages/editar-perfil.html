<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetBooking - Editar Perfil</title>
    <link rel="stylesheet" href="../styles/new-style.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/editar-perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header/Navbar -->
    <header class="header">
        <div class="navbar">
            <a href="../index.html" class="logo">
                <img src="../img/Imagem do WhatsApp de 2025-09-17 à(s) 15.28.08_75e67870.jpg" alt="VetBooking Logo">
                <span class="logo-text">VetBooking</span>
            </a>
            <div class="nav-links">
                <a href="../index.html" class="nav-link">Página Inicial</a>
                <a href="./catalogo-clinicas.html" class="nav-link">Clínicas</a>
                <a href="./como-funciona.html" class="nav-link">Como Funciona</a>
            </div>
            <div class="nav-auth">
                <div class="user-menu">
                    <div class="user-info">
                        <span class="user-name">{{ user_name }}</span>
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="dashboard-container">
        <!-- Seção de Perfil do Usuário -->
        <section class="user-profile-section">
            <div class="user-profile-card">
                <div class="user-avatar-large">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <h2 class="user-name-large">{{ user_name }}</h2>
                    <p class="user-type">{{ user_type_display }}</p>
                    <p class="user-since">Membro desde {{ user_since }}</p>
                </div>
            </div>
        </section>

        <!-- Seção de Edição de Perfil -->
        <section class="edit-profile-section">
            <h2 class="section-title">Editar Perfil</h2>

            <form id="edit-form" enctype="multipart/form-data">
                <!-- Campos exibidos conforme tipo (exemplos genéricos) -->
                {% if user_type == 'tutor' %}
                    <label>Nome</label>
                    <input name="nome" value="{{ tutor.nome_tutores or '' }}" required>
                    <label>Email</label>
                    <input name="email" value="{{ tutor.email or '' }}" type="email" required>
                    <label>Data de Nascimento</label>
                    <input name="data_nascimento" value="{{ tutor.data_nascimento or '' }}" type="date">
                    <label>Telefone</label>
                    <input name="telefone" value="{{ tutor.telefone or '' }}">
                {% elif user_type == 'clinica' %}
                    <label>Razão Social</label>
                    <input name="razao_social" value="{{ clinica.razao_social or '' }}" required>
                    <label>Email</label>
                    <input name="email" value="{{ clinica.email or '' }}" type="email" required>
                    <label>Telefone</label>
                    <input name="telefone" value="{{ clinica.telefone or '' }}">
                    <label>CEP</label>
                    <input name="cep" value="{{ clinica.cep or '' }}">
                    <label>Cidade</label>
                    <input name="cidade" value="{{ clinica.cidade or '' }}">
                    <label>UF</label>
                    <input name="uf" value="{{ clinica.uf or '' }}">
                {% else %}
                    <label>Nome</label>
                    <input name="nome_medico" value="{{ medico.nome_medico or '' }}" required>
                    <label>Email</label>
                    <input name="email" value="{{ medico.email or '' }}" type="email" required>
                    <label>CRMV</label>
                    <input name="crmv" value="{{ medico.crmv or '' }}">
                    <label>Especialidades</label>
                    <input name="especialidades" value="{{ medico.especialidades or '' }}">
                    <label>Descrição</label>
                    <textarea name="descricao">{{ medico.descricao or '' }}</textarea>
                {% endif %}

                <div style="margin-top:12px;">
                    <button id="btn-save" type="submit">Salvar</button>
                    <button id="btn-cancel" type="button" class="btn">Voltar</button>
                </div>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-logo">
                <img src="../img/WhatsApp Image 2024-09-26 at 13.36.23 (1).jpeg" alt="VetBooking Logo">
                <span class="logo-text">VetBooking</span>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h3 class="footer-title">Sobre</h3>
                    <a href="#" class="footer-link">Quem Somos</a>
                    <a href="#" class="footer-link">Como Funciona</a>
                    <a href="#" class="footer-link">Termos de Uso</a>
                    <a href="#" class="footer-link">Privacidade</a>
                </div>
                <div class="footer-column">
                    <h3 class="footer-title">Para Profissionais</h3>
                    <a href="cadastro-clinica.html" class="footer-link">Cadastre sua Clínica</a>
                    <a href="#" class="footer-link">Planos e Preços</a>
                </div>
                <div class="footer-column">
                    <h3 class="footer-title">Contato</h3>
                    <a href="#" class="footer-link">Fale Conosco</a>
                    <a href="#" class="footer-link">Suporte</a>
                    <a href="#" class="footer-link">FAQ</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 VetBooking. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        // Toggle user dropdown menu
        document.addEventListener('DOMContentLoaded', function() {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.addEventListener('click', function(e) {
                    this.classList.toggle('active');
                    e.stopPropagation();
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                if (userMenu) {
                    userMenu.classList.remove('active');
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('edit-form');
            const btnSave = document.getElementById('btn-save');
            const btnCancel = document.getElementById('btn-cancel');

            let isDirty = false;
            let allowExit = false; // só permite sair se true (após salvar ou clicar Voltar)

            // marcar form como "dirty" ao alterar qualquer campo
            form.addEventListener('input', () => {
                isDirty = true;
            });

            // Antes de unload: se não permitido, mostrar aviso nativo
            window.addEventListener('beforeunload', (e) => {
                if (!allowExit && isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            // Evitar voltar do histórico enquanto alterações pendentes
            try {
                history.pushState({guard: true}, '', location.href);
                window.addEventListener('popstate', (e) => {
                    if (!allowExit && isDirty) {
                        // Reinsere o estado e impede voltar
                        history.pushState({guard: true}, '', location.href);
                        alert('Você precisa salvar ou clicar em Voltar para sair desta tela.');
                    } else {
                        // permite navegar normalmente
                        allowExit = true;
                        history.back();
                    }
                });
            } catch (err) {
                console.warn('history API indisponível:', err);
            }

            // Bloquear cliques em links enquanto não permitido sair
            document.addEventListener('click', (ev) => {
                const a = ev.target.closest('a');
                if (!a) return;
                const href = a.getAttribute('href') || '';
                // permitir âncoras internas
                if (!allowExit && isDirty && !href.startsWith('#')) {
                    ev.preventDefault();
                    alert('Você precisa salvar ou clicar em Voltar para sair desta tela.');
                }
            }, true);

            // Cancel (Voltar) — torna exit permitido e redireciona para dashboard
            btnCancel.addEventListener('click', () => {
                // confirmar intencionalmente sair sem salvar
                const ok = confirm('Deseja realmente voltar sem salvar? Todas as alterações serão perdidas.');
                if (ok) {
                    allowExit = true;
                    window.location.href = '/dashboard';
                }
            });

            // Submit por fetch para receber redirect e redirecionar automaticamente
            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                btnSave.disabled = true;
                btnSave.textContent = 'Salvando...';

                const fd = new FormData(form);
                try {
                    const res = await fetch('/editar-perfil', {
                        method: 'POST',
                        body: fd,
                        credentials: 'same-origin'
                    });
                    const json = await res.json();
                    if (json.success) {
                        // permitir saída e redirecionar
                        allowExit = true;
                        isDirty = false;
                        window.location.href = json.redirect || '/dashboard';
                    } else {
                        alert('Erro ao salvar: ' + (json.message || 'Erro desconhecido'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('Erro ao salvar. Veja o console.');
                } finally {
                    btnSave.disabled = false;
                    btnSave.textContent = 'Salvar';
                }
            });
        });
    </script>
</body>
</html>