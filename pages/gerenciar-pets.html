<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pets - VetBooking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/gerenciar-pets.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="navbar">
            <a href="{{ url_for('index') }}" class="logo">
                <span class="logo-text">VetBooking</span>
            </a>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link">Página Inicial</a>
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
            </div>
            <div class="nav-auth">
                <div class="user-menu">
                    <div class="user-info">
                        <span class="user-name">{{ session.get('user_name', 'Usuário') }}</span>
                    </div>
                    <a href="/logout" style="margin-left: 10px; color: white;"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="header-section">
            <h1>Meus Pets</h1>
            <p>Gerencie as informações dos seus animais de estimação</p>
        </div>
        
        <button id="btn-adicionar-pet" class="btn-primary">
            <i class="fas fa-plus"></i> Adicionar Novo Pet
        </button>
        
        <div class="pets-grid">
            {% if pets %}
                {% for pet in pets %}
                <div class="pet-card" 
                     data-pet-id="{{ pet.pet_id }}"
                     data-nome="{{ pet.nome_pet }}"
                     data-especie="{{ pet.especie }}"
                     data-raca="{{ pet.raca }}"
                     data-nascimento="{{ pet.data_nascimento.strftime('%Y-%m-%d') if pet.data_nascimento else '' }}"
                     data-sexo="{{ pet.sexo }}"
                     data-peso="{{ pet.peso }}">
                    
                    <div class="pet-header">
                        {% if pet.foto %}
                        <div class="pet-avatar">
                            <img src="{{ url_for('static', filename='uploads/pets/' + pet.foto) }}" alt="{{ pet.nome_pet }}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
                        </div>
                        {% else %}
                        <div class="pet-avatar default">
                            <i class="fas fa-paw"></i>
                        </div>
                        {% endif %}
                        
                        <div class="pet-title">
                            <h2>{{ pet.nome_pet }}</h2>
                            <span class="pet-badge">{{ pet.especie }}</span>
                        </div>
                        <div class="pet-actions">
                            <button class="btn-icon btn-edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pet-details">
                        <div class="detail-item">
                            <i class="fas fa-dna"></i>
                            <span>{{ pet.raca or 'Raça não informada' }}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-birthday-cake"></i>
                            <span>
                                {% if pet.data_nascimento %}
                                    {{ pet.data_nascimento.strftime('%d/%m/%Y') }}
                                {% else %}
                                    Nascimento não informado
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-venus-mars"></i>
                            <span>
                                {{ 'Macho' if pet.sexo == 'M' else 'Fêmea' if pet.sexo == 'F' else 'Sexo não informado' }}
                            </span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-weight"></i>
                            <span>{{ pet.peso or '?' }} kg</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-paw"></i></div>
                    <h3>Nenhum pet cadastrado</h3>
                    <p>Você ainda não cadastrou nenhum animal de estimação</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="modal-pet" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-titulo">Adicionar Novo Pet</h2>
            <form id="form-pet" enctype="multipart/form-data">
                <input type="hidden" id="pet-id" name="pet_id">
                
                <div class="form-group">
                    <label for="foto-pet">Foto do Pet</label>
                    <input type="file" id="foto-pet" name="foto" accept="image/*">
                </div>
                
                <div class="form-group">
                    <label for="nome-pet">Nome do Pet</label>
                    <input type="text" id="nome-pet" name="nome_pet" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="especie">Espécie</label>
                        <select id="especie" name="especie" required>
                            <option value="">Selecione</option>
                            <option value="Cachorro">Cachorro</option>
                            <option value="Gato">Gato</option>
                            <option value="Pássaro">Pássaro</option>
                            <option value="Roedor">Roedor</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="raca">Raça</label>
                        <input type="text" id="raca" name="raca">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="data-nascimento">Nascimento</label>
                        <input type="date" id="data-nascimento" name="data_nascimento">
                    </div>
                    <div class="form-group">
                        <label>Sexo</label>
                        <div>
                            <input type="radio" name="sexo" value="M" id="sexoM"> <label for="sexoM">Macho</label>
                            <input type="radio" name="sexo" value="F" id="sexoF"> <label for="sexoF">Fêmea</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="peso">Peso (kg)</label>
                    <input type="number" id="peso" name="peso" step="0.1">
                </div>
                
                <div class="form-footer">
                    <button type="submit" class="btn-primary">Salvar Pet</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* CSS Básico para o Modal funcionar */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; position: relative; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-primary { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        .btn-primary:hover { background: #218838; }
    </style>

    <script>
        // Elementos
        const modal = document.getElementById('modal-pet');
        const btnAdicionar = document.getElementById('btn-adicionar-pet');
        const spanFechar = document.querySelector('.close');
        const formPet = document.getElementById('form-pet');
        const modalTitulo = document.getElementById('modal-titulo');

        // Abrir Modal (Adicionar)
        btnAdicionar.onclick = function() {
            formPet.reset();
            document.getElementById('pet-id').value = '';
            modalTitulo.textContent = 'Adicionar Novo Pet';
            modal.style.display = 'block';
        }

        // Fechar Modal
        spanFechar.onclick = function() { modal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == modal) modal.style.display = 'none'; }

        // Botão EDITAR - Agora usa os data-attributes (Muito mais seguro)
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.pet-card');
                
                // Pega os dados diretos do HTML (data-attributes)
                document.getElementById('pet-id').value = card.dataset.petId;
                document.getElementById('nome-pet').value = card.dataset.nome;
                document.getElementById('especie').value = card.dataset.especie;
                document.getElementById('raca').value = card.dataset.raca;
                document.getElementById('data-nascimento').value = card.dataset.nascimento; // Formato YYYY-MM-DD já vem pronto
                document.getElementById('peso').value = card.dataset.peso;

                // Seleciona o sexo
                if (card.dataset.sexo === 'M') document.getElementById('sexoM').checked = true;
                else if (card.dataset.sexo === 'F') document.getElementById('sexoF').checked = true;

                modalTitulo.textContent = 'Editar Pet';
                modal.style.display = 'block';
            });
        });

        // Botão EXCLUIR
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.pet-card');
                const petId = card.dataset.petId;

                if(confirm('Tem certeza que deseja excluir este pet?')) {
                    fetch('/excluir-pet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pet_id: petId })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            card.remove();
                            alert('Pet excluído com sucesso!');
                            // Se não sobrar nenhum, recarregar para mostrar o empty state
                            if(document.querySelectorAll('.pet-card').length === 0) location.reload();
                        } else {
                            alert('Erro ao excluir: ' + data.message);
                        }
                    })
                    .catch(err => console.error(err));
                }
            });
        });

        // Salvar (Adicionar ou Editar)
        formPet.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const id = document.getElementById('pet-id').value;
            const url = id ? '/atualizar-pet' : '/adicionar-pet';

            fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin' // garante envio de cookie/session
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Erro no envio da imagem. Veja o console.');
            });
        });
    </script>
</body>
</html>